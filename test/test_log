============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.2.2, pluggy-1.5.0
rootdir: /Users/yiranwan/workplace/ContractTestPy/aws-otel-dotnet-instrumentation/test/contract-tests/tests
configfile: pyproject.toml
plugins: anyio-4.2.0
collected 4 items

contract-tests/tests/test/amazon/awssdk/awssdk_test.py::AWSSdkTest::test_kinesis_error 
-------------------------------- live log setup --------------------------------
2024-07-19 14:03:22 [    INFO] Pulling image aws-application-signals-mock-collector (container.py:53)
2024-07-19 14:03:23 [    INFO] Container started: fb9d072c73a1 (container.py:64)
2024-07-19 14:03:24 [    INFO] Pulling image localstack/localstack:3.0.2 (container.py:53)
2024-07-19 14:03:24 [    INFO] Container started: 0c511e64bd28 (container.py:64)
-------------------------------- live log call ---------------------------------
2024-07-19 14:03:27 [    INFO] Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app (container.py:53)
2024-07-19 14:03:28 [    INFO] Container started: b6f105e65d9d (container.py:64)
2024-07-19 14:06:01 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:06:01 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:06:21 [    INFO] Application stdout (contract_test_base.py:123)
2024-07-19 14:06:21 [    INFO] info: AWS.Distro.OpenTelemetry.AutoInstrumentation.Plugin[0]
      AWS Application Signals enabled
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
fail: TestSimpleApp.AWSSDK.Core.KinesisTests[0]
      Expected exception occurred Amazon.Kinesis.Model.ResourceNotFoundException: Stream arn arn:aws:kinesis:us-east-1:000000000000:stream/test_stream_error not found
       ---> Amazon.Runtime.Internal.HttpErrorResponseException: Exception of type 'Amazon.Runtime.Internal.HttpErrorResponseException' was thrown.
         at Amazon.Runtime.HttpWebRequestMessage.ProcessHttpResponseMessage(HttpResponseMessage responseMessage)
         at Amazon.Runtime.HttpWebRequestMessage.GetResponseAsync(CancellationToken cancellationToken)
         at Amazon.Runtime.Internal.HttpHandler`1.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.Unmarshaller.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.ErrorHandler.InvokeAsync[T](IExecutionContext executionContext)
         --- End of inner exception stack trace ---
         at Amazon.Runtime.Internal.HttpErrorResponseExceptionHandler.HandleExceptionStream(IRequestContext requestContext, IWebResponseData httpErrorResponse, HttpErrorResponseException exception, Stream responseStream)
         at Amazon.Runtime.Internal.HttpErrorResponseExceptionHandler.HandleExceptionAsync(IExecutionContext executionContext, HttpErrorResponseException exception)
         at Amazon.Runtime.Internal.ExceptionHandler`1.HandleAsync(IExecutionContext executionContext, Exception exception)
         at Amazon.Runtime.Internal.ErrorHandler.ProcessExceptionAsync(IExecutionContext executionContext, Exception exception)
         at Amazon.Runtime.Internal.ErrorHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.Signer.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.EndpointDiscoveryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.EndpointDiscoveryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CredentialsRetriever.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.RetryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.RetryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at OpenTelemetry.Instrumentation.AWS.Implementation.AWSPropagatorPipelineHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at OpenTelemetry.Instrumentation.AWS.Implementation.AWSTracingPipelineHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.ErrorCallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.MetricsHandler.InvokeAsync[T](IExecutionContext executionContext)
         at TestSimpleApp.AWSSDK.Core.ContractTest.Error() in /src/ContractTest.cs:line 38
 (contract_test_base.py:124)
2024-07-19 14:06:21 [    INFO] Application stderr (contract_test_base.py:125)
2024-07-19 14:06:21 [    INFO]  (contract_test_base.py:126)
FAILED                                                                   [ 25%]
contract-tests/tests/test/amazon/awssdk/awssdk_test.py::AWSSdkTest::test_s3_create_bucket 
-------------------------------- live log call ---------------------------------
2024-07-19 14:06:21 [    INFO] Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app (container.py:53)
2024-07-19 14:06:21 [    INFO] Container started: 8e04efdcaa8e (container.py:64)
2024-07-19 14:08:53 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:08:53 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:09:14 [    INFO] Application stdout (contract_test_base.py:123)
2024-07-19 14:09:14 [    INFO] info: AWS.Distro.OpenTelemetry.AutoInstrumentation.Plugin[0]
      AWS Application Signals enabled
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
 (contract_test_base.py:124)
2024-07-19 14:09:14 [    INFO] Application stderr (contract_test_base.py:125)
2024-07-19 14:09:14 [    INFO]  (contract_test_base.py:126)
FAILED                                                                   [ 50%]
contract-tests/tests/test/amazon/awssdk/awssdk_test.py::AWSSdkTest::test_sqs_create_queue 
-------------------------------- live log call ---------------------------------
2024-07-19 14:09:14 [    INFO] Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app (container.py:53)
2024-07-19 14:09:15 [    INFO] Container started: 46b4bba40e96 (container.py:64)
2024-07-19 14:11:47 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:11:47 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:12:07 [    INFO] Application stdout (contract_test_base.py:123)
2024-07-19 14:12:07 [    INFO] info: AWS.Distro.OpenTelemetry.AutoInstrumentation.Plugin[0]
      AWS Application Signals enabled
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
 (contract_test_base.py:124)
2024-07-19 14:12:07 [    INFO] Application stderr (contract_test_base.py:125)
2024-07-19 14:12:08 [    INFO]  (contract_test_base.py:126)
FAILED                                                                   [ 75%]
contract-tests/tests/test/amazon/awssdk/awssdk_test.py::AWSSdkTest::test_sqs_send_message 
-------------------------------- live log call ---------------------------------
2024-07-19 14:12:08 [    INFO] Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app (container.py:53)
2024-07-19 14:12:08 [    INFO] Container started: cee64cb1894e (container.py:64)
2024-07-19 14:14:41 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:14:41 [    INFO] Waiting to be ready... (waiting_utils.py:46)
2024-07-19 14:15:01 [    INFO] Application stdout (contract_test_base.py:123)
2024-07-19 14:15:01 [    INFO] info: AWS.Distro.OpenTelemetry.AutoInstrumentation.Plugin[0]
      AWS Application Signals enabled
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
 (contract_test_base.py:124)
2024-07-19 14:15:01 [    INFO] Application stderr (contract_test_base.py:125)
2024-07-19 14:15:01 [    INFO]  (contract_test_base.py:126)
PASSED                                                                   [100%]
------------------------------ live log teardown -------------------------------
2024-07-19 14:15:01 [    INFO] LocalStack stdout (awssdk_test.py:86)
2024-07-19 14:15:01 [    INFO] 
LocalStack version: 3.0.2
LocalStack build date: 2023-11-29
LocalStack build git hash: 60518e11

2024-07-19T21:03:27.245  WARN --- [  MainThread] localstack.deprecations    : DEFAULT_REGION is deprecated (since 0.12.7) and will be removed in upcoming releases of LocalStack! LocalStack now has full multi-region support. This option has no effect. Please remove it from your configuration.
2024-07-19T21:03:27.749  INFO --- [-functhread4] hypercorn.error            : Running on https://0.0.0.0:4566 (CTRL + C to quit)
2024-07-19T21:03:27.749  INFO --- [-functhread4] hypercorn.error            : Running on https://0.0.0.0:4566 (CTRL + C to quit)
2024-07-19T21:03:27.867  INFO --- [  MainThread] localstack.utils.bootstrap : Execution of "start_runtime_components" took 603.51ms
Ready.
2024-07-19T21:06:01.827  INFO --- [   asgi_gw_0] l.s.k.kinesis_mock_server  : Creating kinesis backend for account 000000000000
2024-07-19T21:06:03.858  INFO --- [functhread24] l.s.k.kinesis_mock_server  : [info] kinesis.mock.KinesisMockService$ 2024-07-19T21:06:03.843766Z contextId=b99cea5b-6601-4ca9-b245-e95d80601485, cacheConfig={"awsAccountId":"000000000000","awsRegion":"us-east-1","createStreamDuration":{"length":500,"unit":"MILLISECONDS"},"deleteStreamDuration":{"length":500,"unit":"MILLISECONDS"},"deregisterStreamConsumerDuration":{"length":500,"unit":"MILLISECONDS"},"initializeStreams":null,"logLevel":"INFO","mergeShardsDuration":{"length":500,"unit":"MILLISECONDS"},"onDemandStreamCountLimit":10,"persistConfig":{"fileName":"000000000000.json","interval":{"length":5,"unit":"SECONDS"},"loadIfExists":true,"path":"../../../tmp/localstack/state/kinesis","shouldPersist":true},"registerStreamConsumerDuration":{"length":500,"unit":"MILLISECONDS"},"shardLimit":100,"splitShardDuration":{"length":500,"unit":"MILLISECONDS"},"startStreamEncryptionDuration":{"length":500,"unit":"MILLISECONDS"},"stopStreamEncryptionDuration":{"length":500,"unit":"MILLISECONDS"},"updateShardCountDuration":{"length":500,"unit":"MILLISECONDS"}} Logging Cache Config
2024-07-19T21:06:04.034  INFO --- [functhread24] l.s.k.kinesis_mock_server  : [info] kinesis.mock.KinesisMockService$ 2024-07-19T21:06:04.034370Z  Starting Kinesis TLS Mock Service on port 38185
2024-07-19T21:06:04.035  INFO --- [functhread24] l.s.k.kinesis_mock_server  : [info] kinesis.mock.KinesisMockService$ 2024-07-19T21:06:04.034879Z  Starting Kinesis Plain Mock Service on port 59645
2024-07-19T21:06:04.041  INFO --- [functhread24] l.s.k.kinesis_mock_server  : [info] kinesis.mock.KinesisMockService$ 2024-07-19T21:06:04.041315Z contextId=4abe79b0-4338-4a95-9a95-dbb443e7837d Starting persist data loop
2024-07-19T21:06:04.209  INFO --- [functhread24] l.s.k.kinesis_mock_server  : [warn] kinesis.mock.cache.Cache 2024-07-19T21:06:04.209365Z x-amz-id-2=skFNqe0GlSmn9/liRc/LVcL0Vmi+q1FdTP/Xqof1dV1KB0mxyfT6iKbZ51YyT26tiVb6ZKq+25AoN3Z71Pq4dpI8VydLpKP5, contentType=application/x-amz-json-1.1, x-amzn-RequestId=b66e4f4b-810b-45ca-b0f8-2d8567236d03, action=DeleteStream, contextId=7d417e2f-1e61-4a05-a5f2-26dd274120c6, streamName=test_stream_error Deleting stream was unuccessful
2024-07-19T21:06:04.211  INFO --- [functhread24] l.s.k.kinesis_mock_server  : kinesis.mock.ResourceNotFoundException: Stream arn arn:aws:kinesis:us-east-1:000000000000:stream/test_stream_error not found
2024-07-19T21:06:04.211  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at UC(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:718:72)
2024-07-19T21:06:04.211  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at {anonymous}()(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:3288:191)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at w.h(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:2942:262)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at {anonymous}()(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:3725:219)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at u.ra(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:2942:45)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at z7(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:4435:368)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at e.Nk(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:4461:328)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at ZN.Nk(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:1376:197)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at {anonymous}()(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:3605:53)
2024-07-19T21:06:04.212  INFO --- [functhread24] l.s.k.kinesis_mock_server  : at u.ra(/var/lib/localstack/lib/kinesis-local/0.4.4/node_modules/kinesis-local/main.js:2942:45)
2024-07-19T21:06:04.237  INFO --- [   asgi_gw_0] localstack.request.aws     : AWS kinesis.DeleteStream => 400 (ResourceNotFoundException)
2024-07-19T21:08:55.074  INFO --- [   asgi_gw_1] localstack.request.aws     : AWS s3.CreateBucket => 200
2024-07-19T21:11:48.461  INFO --- [   asgi_gw_1] localstack.request.aws     : AWS sqs.CreateQueue => 200
2024-07-19T21:14:41.644  INFO --- [   asgi_gw_0] localstack.request.aws     : AWS sqs.SendMessage => 200
 (awssdk_test.py:87)
2024-07-19 14:15:01 [    INFO] LocalStack stderr (awssdk_test.py:88)
2024-07-19 14:15:01 [    INFO]  (awssdk_test.py:89)
2024-07-19 14:15:01 [    INFO] MockCollector stdout (contract_test_base.py:71)
2024-07-19 14:15:01 [    INFO] Ready
 (contract_test_base.py:72)
2024-07-19 14:15:01 [    INFO] MockCollector stderr (contract_test_base.py:73)
2024-07-19 14:15:01 [    INFO]  (contract_test_base.py:74)


=================================== FAILURES ===================================
________________________ AWSSdkTest.test_kinesis_error _________________________

self = <awssdk_test.AWSSdkTest testMethod=test_kinesis_error>

    def test_kinesis_error(self):
>       self.do_test_requests(
            "kinesis/error",
            "GET",
            400,
            0,
            1,
            remote_service="AWS::Kinesis",
            remote_operation="DeleteStream",
            remote_resource_type="AWS::Kinesis::Stream",
            remote_resource_identifier="test_stream_error",
            request_specific_attributes={
                _AWS_KINESIS_STREAM_NAME: "test_stream_error",
            },
            span_name="Kinesis.DeleteStream",
        )

contract-tests/tests/test/amazon/awssdk/awssdk_test.py:367: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../../Library/Python/3.9/lib/python/site-packages/amazon/base/contract_test_base.py:150: in do_test_requests
    self._assert_metric_attributes(metrics, ERROR_METRIC, expected_error, **kwargs)
contract-tests/tests/test/amazon/awssdk/awssdk_test.py:520: in _assert_metric_attributes
    self.check_sum(metric_name, dependency_dp.sum, expected_sum)
../../../../Library/Python/3.9/lib/python/site-packages/amazon/base/contract_test_base.py:180: in check_sum
    self.assertEqual(actual_sum, expected_sum)
E   AssertionError: 1.0 != 0
---------------------------- Captured stderr setup -----------------------------
Pulling image aws-application-signals-mock-collector
Container started: fb9d072c73a1
Pulling image localstack/localstack:3.0.2
Container started: 0c511e64bd28
------------------------------ Captured log setup ------------------------------
INFO     testcontainers.core.container:container.py:53 Pulling image aws-application-signals-mock-collector
INFO     testcontainers.core.container:container.py:64 Container started: fb9d072c73a1
INFO     testcontainers.core.container:container.py:53 Pulling image localstack/localstack:3.0.2
INFO     testcontainers.core.container:container.py:64 Container started: 0c511e64bd28
----------------------------- Captured stdout call -----------------------------
name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /kinesis"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.remote.operation"
      value {
        string_value: "DeleteStream"
      }
    }
    attributes {
      key: "aws.remote.resource.identifier"
      value {
        string_value: "test_stream_error"
      }
    }
    attributes {
      key: "aws.remote.resource.type"
      value {
        string_value: "AWS::Kinesis::Stream"
      }
    }
    attributes {
      key: "aws.remote.service"
      value {
        string_value: "AWS::Kinesis"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "CLIENT"
      }
    }
    start_time_unix_nano: 1721423164310129900
    time_unix_nano: 1721423164361454100
    count: 1
    sum: 2734.2713
    scale: 20
    positive {
      offset: 11971529
      bucket_counts: 1
    }
    min: 2734.2713
    max: 2734.2713
  }
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /kinesis"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "LOCAL_ROOT"
      }
    }
    start_time_unix_nano: 1721423164310129900
    time_unix_nano: 1721423164361454100
    count: 1
    sum: 3029.6522
    scale: 20
    positive {
      offset: 12126714
      bucket_counts: 1
    }
    min: 3029.6522
    max: 3029.6522
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

name: "Error"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /kinesis"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.remote.operation"
      value {
        string_value: "DeleteStream"
      }
    }
    attributes {
      key: "aws.remote.resource.identifier"
      value {
        string_value: "test_stream_error"
      }
    }
    attributes {
      key: "aws.remote.resource.type"
      value {
        string_value: "AWS::Kinesis::Stream"
      }
    }
    attributes {
      key: "aws.remote.service"
      value {
        string_value: "AWS::Kinesis"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "CLIENT"
      }
    }
    start_time_unix_nano: 1721423164310129300
    time_unix_nano: 1721423164361442100
    count: 1
    sum: 1
    scale: 20
    positive {
      offset: -1
      bucket_counts: 1
    }
    min: 1
    max: 1
  }
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /kinesis"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "LOCAL_ROOT"
      }
    }
    start_time_unix_nano: 1721423164310129300
    time_unix_nano: 1721423164361442100
    count: 1
    sum: 1
    scale: 20
    positive {
      offset: -1
      bucket_counts: 1
    }
    min: 1
    max: 1
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

----------------------------- Captured stderr call -----------------------------
Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app
Container started: b6f105e65d9d
Waiting to be ready...
Waiting to be ready...
------------------------------ Captured log call -------------------------------
INFO     testcontainers.core.container:container.py:53 Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app
INFO     testcontainers.core.container:container.py:64 Container started: b6f105e65d9d
INFO     testcontainers.core.waiting_utils:waiting_utils.py:46 Waiting to be ready...
INFO     testcontainers.core.waiting_utils:waiting_utils.py:46 Waiting to be ready...
INFO     amazon.base.contract_test_base:contract_test_base.py:123 Application stdout
INFO     amazon.base.contract_test_base:contract_test_base.py:124 info: AWS.Distro.OpenTelemetry.AutoInstrumentation.Plugin[0]
      AWS Application Signals enabled
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
fail: TestSimpleApp.AWSSDK.Core.KinesisTests[0]
      Expected exception occurred Amazon.Kinesis.Model.ResourceNotFoundException: Stream arn arn:aws:kinesis:us-east-1:000000000000:stream/test_stream_error not found
       ---> Amazon.Runtime.Internal.HttpErrorResponseException: Exception of type 'Amazon.Runtime.Internal.HttpErrorResponseException' was thrown.
         at Amazon.Runtime.HttpWebRequestMessage.ProcessHttpResponseMessage(HttpResponseMessage responseMessage)
         at Amazon.Runtime.HttpWebRequestMessage.GetResponseAsync(CancellationToken cancellationToken)
         at Amazon.Runtime.Internal.HttpHandler`1.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.Unmarshaller.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.ErrorHandler.InvokeAsync[T](IExecutionContext executionContext)
         --- End of inner exception stack trace ---
         at Amazon.Runtime.Internal.HttpErrorResponseExceptionHandler.HandleExceptionStream(IRequestContext requestContext, IWebResponseData httpErrorResponse, HttpErrorResponseException exception, Stream responseStream)
         at Amazon.Runtime.Internal.HttpErrorResponseExceptionHandler.HandleExceptionAsync(IExecutionContext executionContext, HttpErrorResponseException exception)
         at Amazon.Runtime.Internal.ExceptionHandler`1.HandleAsync(IExecutionContext executionContext, Exception exception)
         at Amazon.Runtime.Internal.ErrorHandler.ProcessExceptionAsync(IExecutionContext executionContext, Exception exception)
         at Amazon.Runtime.Internal.ErrorHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.Signer.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.EndpointDiscoveryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.EndpointDiscoveryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CredentialsRetriever.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.RetryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.RetryHandler.InvokeAsync[T](IExecutionContext executionContext)
         at OpenTelemetry.Instrumentation.AWS.Implementation.AWSPropagatorPipelineHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at OpenTelemetry.Instrumentation.AWS.Implementation.AWSTracingPipelineHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.CallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.ErrorCallbackHandler.InvokeAsync[T](IExecutionContext executionContext)
         at Amazon.Runtime.Internal.MetricsHandler.InvokeAsync[T](IExecutionContext executionContext)
         at TestSimpleApp.AWSSDK.Core.ContractTest.Error() in /src/ContractTest.cs:line 38

INFO     amazon.base.contract_test_base:contract_test_base.py:125 Application stderr
INFO     amazon.base.contract_test_base:contract_test_base.py:126
_______________________ AWSSdkTest.test_s3_create_bucket _______________________

self = <awssdk_test.AWSSdkTest testMethod=test_s3_create_bucket>

    def test_s3_create_bucket(self):
>       self.do_test_requests(
            "s3/createbucket/create-bucket/test-bucket-name",
            "GET",
            200,
            0,
            0,
            remote_service="AWS::S3",
            remote_operation="PutBucket",
            remote_resource_type="AWS::S3::Bucket",
            remote_resource_identifier="test-bucket-name",
            request_specific_attributes={
                SpanAttributes.AWS_S3_BUCKET: "test-bucket-name",
            },
            span_name="S3.PutBucket",
        )

contract-tests/tests/test/amazon/awssdk/awssdk_test.py:93: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../../Library/Python/3.9/lib/python/site-packages/amazon/base/contract_test_base.py:149: in do_test_requests
    self._assert_metric_attributes(metrics, LATENCY_METRIC, 5000, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <awssdk_test.AWSSdkTest testMethod=test_s3_create_bucket>
resource_scope_metrics = [<mock_collector_client.ResourceScopeMetric object at 0x102281400>, <mock_collector_client.ResourceScopeMetric object ...r_client.ResourceScopeMetric object at 0x102281d90>, <mock_collector_client.ResourceScopeMetric object at 0x102281df0>]
metric_name = 'latency', expected_sum = 5000
kwargs = {'remote_operation': 'PutBucket', 'remote_resource_identifier': 'test-bucket-name', 'remote_resource_type': 'AWS::S3::Bucket', 'remote_service': 'AWS::S3', ...}
target_metrics = [name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.o..._counts: 1
    }
    min: 1145.2627
    max: 1145.2627
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}
]
resource_scope_metric = <mock_collector_client.ResourceScopeMetric object at 0x102281df0>
target_metric = name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.op...ket_counts: 1
    }
    min: 778.9251
    max: 778.9251
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

dp_list = [attributes {
  key: "aws.local.operation"
  value {
    string_value: "GET /s3"
  }
}
attributes {
  key: "aws.local....35200
count: 1
sum: 778.9251
scale: 20
positive {
  offset: 10071929
  bucket_counts: 1
}
min: 778.9251
max: 778.9251
]
dependency_dp = attributes {
  key: "aws.local.operation"
  value {
    string_value: "GET /s3"
  }
}
attributes {
  key: "aws.local.s...335200
count: 1
sum: 778.9251
scale: 20
positive {
  offset: 10071929
  bucket_counts: 1
}
min: 778.9251
max: 778.9251


    @override
    def _assert_metric_attributes(
        self,
        resource_scope_metrics: List[ResourceScopeMetric],
        metric_name: str,
        expected_sum: int,
        **kwargs,
    ) -> None:
        target_metrics: List[Metric] = []
        for resource_scope_metric in resource_scope_metrics:
            if resource_scope_metric.metric.name.lower() == metric_name.lower():
                target_metrics.append(resource_scope_metric.metric)
    
        #self.assertEqual(len(target_metrics), 1)
        target_metric: Metric = target_metrics[0]
        print(target_metric)
        if len(target_metrics) > 1:
            print(target_metrics[1])
        dp_list: List[ExponentialHistogramDataPoint] = target_metric.exponential_histogram.data_points
        #dp_list_count: int = kwargs.get("dp_count", 1)
        #self.assertEqual(len(dp_list), dp_list_count)
        dependency_dp: ExponentialHistogramDataPoint = dp_list[0]
>       service_dp: ExponentialHistogramDataPoint = dp_list[1]
E       IndexError: list index out of range

contract-tests/tests/test/amazon/awssdk/awssdk_test.py:505: IndexError
----------------------------- Captured stdout call -----------------------------
name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /s3"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.remote.operation"
      value {
        string_value: "PutBucket"
      }
    }
    attributes {
      key: "aws.remote.resource.identifier"
      value {
        string_value: "test-bucket-name"
      }
    }
    attributes {
      key: "aws.remote.resource.type"
      value {
        string_value: "AWS::S3::Bucket"
      }
    }
    attributes {
      key: "aws.remote.service"
      value {
        string_value: "AWS::S3"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "CLIENT"
      }
    }
    start_time_unix_nano: 1721423335075929300
    time_unix_nano: 1721423335127335200
    count: 1
    sum: 778.9251
    scale: 20
    positive {
      offset: 10071929
      bucket_counts: 1
    }
    min: 778.9251
    max: 778.9251
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /s3"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "LOCAL_ROOT"
      }
    }
    start_time_unix_nano: 1721423335127335200
    time_unix_nano: 1721423335176029600
    count: 1
    sum: 1145.2627
    scale: 20
    positive {
      offset: 10655066
      bucket_counts: 1
    }
    min: 1145.2627
    max: 1145.2627
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

----------------------------- Captured stderr call -----------------------------
Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app
Container started: 8e04efdcaa8e
Waiting to be ready...
Waiting to be ready...
------------------------------ Captured log call -------------------------------
INFO     testcontainers.core.container:container.py:53 Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app
INFO     testcontainers.core.container:container.py:64 Container started: 8e04efdcaa8e
INFO     testcontainers.core.waiting_utils:waiting_utils.py:46 Waiting to be ready...
INFO     testcontainers.core.waiting_utils:waiting_utils.py:46 Waiting to be ready...
INFO     amazon.base.contract_test_base:contract_test_base.py:123 Application stdout
INFO     amazon.base.contract_test_base:contract_test_base.py:124 info: AWS.Distro.OpenTelemetry.AutoInstrumentation.Plugin[0]
      AWS Application Signals enabled
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app

INFO     amazon.base.contract_test_base:contract_test_base.py:125 Application stderr
INFO     amazon.base.contract_test_base:contract_test_base.py:126
_______________________ AWSSdkTest.test_sqs_create_queue _______________________

self = <awssdk_test.AWSSdkTest testMethod=test_sqs_create_queue>

    def test_sqs_create_queue(self):
>       self.do_test_requests(
            "sqs/createqueue/some-queue",
            "GET",
            200,
            0,
            0,
            remote_service="AWS::SQS",
            remote_operation="CreateQueue",
            remote_resource_type="AWS::SQS::Queue",
            remote_resource_identifier="test_queue",
            request_specific_attributes={
                _AWS_SQS_QUEUE_NAME: "test_queue",
            },
            span_name="SQS.CreateQueue",
        )

contract-tests/tests/test/amazon/awssdk/awssdk_test.py:248: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../../Library/Python/3.9/lib/python/site-packages/amazon/base/contract_test_base.py:149: in do_test_requests
    self._assert_metric_attributes(metrics, LATENCY_METRIC, 5000, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <awssdk_test.AWSSdkTest testMethod=test_sqs_create_queue>
resource_scope_metrics = [<mock_collector_client.ResourceScopeMetric object at 0x10223d460>, <mock_collector_client.ResourceScopeMetric object ...r_client.ResourceScopeMetric object at 0x10223d610>, <mock_collector_client.ResourceScopeMetric object at 0x10223d670>]
metric_name = 'latency', expected_sum = 5000
kwargs = {'remote_operation': 'CreateQueue', 'remote_resource_identifier': 'test_queue', 'remote_resource_type': 'AWS::SQS::Queue', 'remote_service': 'AWS::SQS', ...}
target_metrics = [name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.o...cket_counts: 1
    }
    min: 601.319
    max: 601.319
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}
]
resource_scope_metric = <mock_collector_client.ResourceScopeMetric object at 0x10223d670>
target_metric = name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.op...ket_counts: 1
    }
    min: 322.4048
    max: 322.4048
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

dp_list = [attributes {
  key: "aws.local.operation"
  value {
    string_value: "GET /sqs"
  }
}
attributes {
  key: "aws.local...549800
count: 1
sum: 322.4048
scale: 20
positive {
  offset: 8737500
  bucket_counts: 1
}
min: 322.4048
max: 322.4048
]
dependency_dp = attributes {
  key: "aws.local.operation"
  value {
    string_value: "GET /sqs"
  }
}
attributes {
  key: "aws.local....9549800
count: 1
sum: 322.4048
scale: 20
positive {
  offset: 8737500
  bucket_counts: 1
}
min: 322.4048
max: 322.4048


    @override
    def _assert_metric_attributes(
        self,
        resource_scope_metrics: List[ResourceScopeMetric],
        metric_name: str,
        expected_sum: int,
        **kwargs,
    ) -> None:
        target_metrics: List[Metric] = []
        for resource_scope_metric in resource_scope_metrics:
            if resource_scope_metric.metric.name.lower() == metric_name.lower():
                target_metrics.append(resource_scope_metric.metric)
    
        #self.assertEqual(len(target_metrics), 1)
        target_metric: Metric = target_metrics[0]
        print(target_metric)
        if len(target_metrics) > 1:
            print(target_metrics[1])
        dp_list: List[ExponentialHistogramDataPoint] = target_metric.exponential_histogram.data_points
        #dp_list_count: int = kwargs.get("dp_count", 1)
        #self.assertEqual(len(dp_list), dp_list_count)
        dependency_dp: ExponentialHistogramDataPoint = dp_list[0]
>       service_dp: ExponentialHistogramDataPoint = dp_list[1]
E       IndexError: list index out of range

contract-tests/tests/test/amazon/awssdk/awssdk_test.py:505: IndexError
----------------------------- Captured stdout call -----------------------------
name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /sqs"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.remote.operation"
      value {
        string_value: "CreateQueue"
      }
    }
    attributes {
      key: "aws.remote.resource.identifier"
      value {
        string_value: "test_queue"
      }
    }
    attributes {
      key: "aws.remote.resource.type"
      value {
        string_value: "AWS::SQS::Queue"
      }
    }
    attributes {
      key: "aws.remote.service"
      value {
        string_value: "AWS::SQS"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "CLIENT"
      }
    }
    start_time_unix_nano: 1721423508457319600
    time_unix_nano: 1721423508509549800
    count: 1
    sum: 322.4048
    scale: 20
    positive {
      offset: 8737500
      bucket_counts: 1
    }
    min: 322.4048
    max: 322.4048
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

name: "Latency"
unit: "Milliseconds"
exponential_histogram {
  data_points {
    attributes {
      key: "aws.local.operation"
      value {
        string_value: "GET /sqs"
      }
    }
    attributes {
      key: "aws.local.service"
      value {
        string_value: "aws-application-signals-tests-testsimpleapp.awssdk.core-app"
      }
    }
    attributes {
      key: "aws.span.kind"
      value {
        string_value: "LOCAL_ROOT"
      }
    }
    start_time_unix_nano: 1721423508509549800
    time_unix_nano: 1721423508557297800
    count: 1
    sum: 601.319
    scale: 20
    positive {
      offset: 9680439
      bucket_counts: 1
    }
    min: 601.319
    max: 601.319
  }
  aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
}

----------------------------- Captured stderr call -----------------------------
Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app
Container started: 46b4bba40e96
Waiting to be ready...
Waiting to be ready...
------------------------------ Captured log call -------------------------------
INFO     testcontainers.core.container:container.py:53 Pulling image aws-application-signals-tests-testsimpleapp.awssdk.core-app
INFO     testcontainers.core.container:container.py:64 Container started: 46b4bba40e96
INFO     testcontainers.core.waiting_utils:waiting_utils.py:46 Waiting to be ready...
INFO     testcontainers.core.waiting_utils:waiting_utils.py:46 Waiting to be ready...
INFO     amazon.base.contract_test_base:contract_test_base.py:123 Application stdout
INFO     amazon.base.contract_test_base:contract_test_base.py:124 info: AWS.Distro.OpenTelemetry.AutoInstrumentation.Plugin[0]
      AWS Application Signals enabled
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app

INFO     amazon.base.contract_test_base:contract_test_base.py:125 Application stderr
INFO     amazon.base.contract_test_base:contract_test_base.py:126
=========================== short test summary info ============================
FAILED contract-tests/tests/test/amazon/awssdk/awssdk_test.py::AWSSdkTest::test_kinesis_error
FAILED contract-tests/tests/test/amazon/awssdk/awssdk_test.py::AWSSdkTest::test_s3_create_bucket
FAILED contract-tests/tests/test/amazon/awssdk/awssdk_test.py::AWSSdkTest::test_sqs_create_queue
=================== 3 failed, 1 passed in 706.64s (0:11:46) ====================
